{"version":3,"file":"focus.js","sources":["../../src/dom/focus.ts"],"sourcesContent":["import getElement from './-get-element.ts';\nimport fireEvent from './fire-event.ts';\nimport settled from '../settled.ts';\nimport isFocusable from './-is-focusable.ts';\nimport { isDocument, type Target } from './-target.ts';\nimport { log } from './-logging.ts';\nimport { runHooks, registerHook } from '../helper-hooks.ts';\nimport { __blur__ } from './blur.ts';\nimport getDescription from './-get-description.ts';\n\nregisterHook('focus', 'start', (target: Target) => {\n  log('focus', target);\n});\n\ntype FocusRecord = {\n  focusTarget: HTMLElement | SVGElement;\n  previousFocusedElement?: HTMLElement | SVGElement | null;\n};\n\n/**\n   Get the closest focusable ancestor of a given element (or the element itself\n   if it's focusable)\n\n   @private\n   @param {Element} element the element to trigger events on\n   @returns {HTMLElement|SVGElement|null} the focusable element/ancestor or null\n   if there is none\n */\nfunction getClosestFocusable(\n  element: HTMLElement | Element | Document | SVGElement,\n): HTMLElement | SVGElement | null {\n  if (isDocument(element)) {\n    return null;\n  }\n\n  let maybeFocusable: Element | null = element;\n  while (maybeFocusable && !isFocusable(maybeFocusable)) {\n    maybeFocusable = maybeFocusable.parentElement;\n  }\n\n  return maybeFocusable;\n}\n\n/**\n  @private\n  @param {Element} element the element to trigger events on\n  @return {Promise<FocusRecord | Event | void>} resolves when settled\n*/\nexport function __focus__(\n  element: HTMLElement | Element | Document | SVGElement,\n): Promise<FocusRecord | Event | void> {\n  return Promise.resolve()\n    .then(() => {\n      const focusTarget = getClosestFocusable(element);\n\n      const previousFocusedElement =\n        document.activeElement &&\n        document.activeElement !== focusTarget &&\n        isFocusable(document.activeElement)\n          ? document.activeElement\n          : null;\n\n      // fire __blur__ manually with the null relatedTarget when the target is not focusable\n      // and there was a previously focused element\n      return !focusTarget && previousFocusedElement\n        ? __blur__(previousFocusedElement, null).then(() =>\n            Promise.resolve({ focusTarget, previousFocusedElement }),\n          )\n        : Promise.resolve({ focusTarget, previousFocusedElement });\n    })\n    .then(({ focusTarget, previousFocusedElement }) => {\n      if (!focusTarget) {\n        throw new Error('There was a previously focused element');\n      }\n\n      const browserIsNotFocused = !document?.hasFocus();\n\n      // fire __blur__ manually with the correct relatedTarget when the browser is not\n      // already in focus and there was a previously focused element\n      return previousFocusedElement && browserIsNotFocused\n        ? __blur__(previousFocusedElement, focusTarget).then(() =>\n            Promise.resolve({ focusTarget }),\n          )\n        : Promise.resolve({ focusTarget });\n    })\n    .then(({ focusTarget }) => {\n      // makes `document.activeElement` be `element`. If the browser is focused, it also fires a focus event\n      focusTarget.focus();\n\n      // Firefox does not trigger the `focusin` event if the window\n      // does not have focus. If the document does not have focus then\n      // fire `focusin` event as well.\n      const browserIsFocused = document?.hasFocus();\n      return browserIsFocused\n        ? Promise.resolve()\n        : // if the browser is not focused the previous `el.focus()` didn't fire an event, so we simulate it\n          Promise.resolve()\n            .then(() =>\n              fireEvent(focusTarget as HTMLElement | SVGElement, 'focus', {\n                bubbles: false,\n              }),\n            )\n            .then(() =>\n              fireEvent(focusTarget as HTMLElement | SVGElement, 'focusin'),\n            )\n            .then(() => settled());\n    })\n    .catch(() => {});\n}\n\n/**\n  Focus the specified target.\n\n  Sends a number of events intending to simulate a \"real\" user focusing an\n  element.\n\n  The following events are triggered (in order):\n\n  - `focus`\n  - `focusin`\n\n  The exact listing of events that are triggered may change over time as needed\n  to continue to emulate how actual browsers handle focusing a given element.\n\n  @public\n  @param {string|Element|IDOMElementDescriptor} target the element, selector, or descriptor to focus\n  @return {Promise<void>} resolves when the application is settled\n\n  @example\n  <caption>\n    Emulating focusing an input using `focus`\n  </caption>\n\n  focus('input');\n*/\nexport default function focus(target: Target): Promise<void> {\n  return Promise.resolve()\n    .then(() => runHooks('focus', 'start', target))\n    .then(() => {\n      if (!target) {\n        throw new Error(\n          'Must pass an element, selector, or descriptor to `focus`.',\n        );\n      }\n\n      const element = getElement(target);\n      if (!element) {\n        const description = getDescription(target);\n        throw new Error(\n          `Element not found when calling \\`focus('${description}')\\`.`,\n        );\n      }\n\n      if (!isFocusable(element)) {\n        throw new Error(`${element} is not focusable`);\n      }\n\n      return __focus__(element).then(settled);\n    })\n    .then(() => runHooks('focus', 'end', target));\n}\n"],"names":["registerHook","target","log","getClosestFocusable","element","isDocument","maybeFocusable","isFocusable","parentElement","__focus__","Promise","resolve","then","focusTarget","previousFocusedElement","document","activeElement","__blur__","Error","browserIsNotFocused","hasFocus","focus","browserIsFocused","fireEvent","bubbles","settled","catch","runHooks","getElement","description","getDescription"],"mappings":"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"}