{"version":3,"file":"setup-rendering-context.js","sources":["../src/setup-rendering-context.ts"],"sourcesContent":["import { run } from '@ember/runloop';\nimport { EventDispatcher } from '@ember/-internals/views';\nimport {\n  type BaseContext,\n  type TestContext,\n  isTestContext,\n  getContext,\n} from './setup-context.ts';\nimport settled from './settled.ts';\nimport getRootElement from './dom/get-root-element.ts';\nimport type { Owner } from './build-owner.ts';\nimport getTestMetadata from './test-metadata.ts';\nimport { runHooks } from './helper-hooks.ts';\nimport isComponent from './-internal/is-component.ts';\n\n// the built in types do not provide types for @ember/template-compilation\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\nimport { precompileTemplate } from '@ember/template-compilation';\n\nconst OUTLET_TEMPLATE = precompileTemplate(`{{outlet}}`, { strictMode: false });\nconst EMPTY_TEMPLATE = precompileTemplate(``, { strictMode: false });\nconst INVOKE_PROVIDED_COMPONENT = precompileTemplate(\n  `<this.ProvidedComponent />`,\n  { strictMode: false },\n);\n\nconst hasCalledSetupRenderingContext = Symbol();\n\nexport interface RenderingTestContext extends TestContext {\n  element: Element | Document;\n  [hasCalledSetupRenderingContext]?: true;\n}\n\n//  Isolates the notion of transforming a TextContext into a RenderingTestContext.\n// eslint-disable-next-line require-jsdoc\nfunction prepare(context: TestContext): RenderingTestContext {\n  (context as RenderingTestContext)[hasCalledSetupRenderingContext] = true;\n  return context as RenderingTestContext;\n}\n\n// eslint-disable-next-line require-jsdoc\nexport function isRenderingTestContext(\n  context: BaseContext,\n): context is RenderingTestContext {\n  return isTestContext(context) && hasCalledSetupRenderingContext in context;\n}\n\n/**\n  @private\n  @param {Ember.ApplicationInstance} owner the current owner instance\n  @param {string} templateFullName the fill template name\n  @returns {Template} the template representing `templateFullName`\n*/\nfunction lookupTemplate(owner: Owner, templateFullName: `${string}:${string}`) {\n  const template = owner.lookup(templateFullName);\n  if (typeof template === 'function') return template(owner);\n  return template;\n}\n\n/**\n  @private\n  @param {Ember.ApplicationInstance} owner the current owner instance\n  @returns {Template} a template representing {{outlet}}\n*/\nfunction lookupOutletTemplate(owner: Owner): any {\n  let OutletTemplate = lookupTemplate(owner, 'template:-outlet');\n  if (!OutletTemplate) {\n    owner.register('template:-outlet', OUTLET_TEMPLATE);\n    OutletTemplate = lookupTemplate(owner, 'template:-outlet');\n  }\n\n  return OutletTemplate;\n}\n\nlet templateId = 0;\n\nexport interface RenderOptions {\n  /**\n    The owner object to use as the basis for the template. In most cases you\n    will not need to specify this, however if you are using ember-engines\n    it is possible to specify the _engine's_ owner instead of the host\n    applications.\n  */\n  owner?: Owner;\n}\n\n/**\n  Renders the provided template and appends it to the DOM.\n\n  @public\n  @param {Template|Component} templateFactoryOrComponent the component (or template) to render\n  @param {RenderOptions} options options hash containing engine owner ({ owner: engineOwner })\n  @returns {Promise<void>} resolves when settled\n\n  @example\n  <caption>\n    Render a div element with the class 'container'.\n  </caption>\n  await render(hbs`<div class=\"container\"></div>`);\n*/\nexport function render(\n  templateFactoryOrComponent: object,\n  options?: RenderOptions,\n): Promise<void> {\n  let context = getContext();\n\n  if (!templateFactoryOrComponent) {\n    throw new Error('you must pass a template to `render()`');\n  }\n\n  return Promise.resolve()\n    .then(() => runHooks('render', 'start'))\n    .then(() => {\n      if (!context || !isRenderingTestContext(context)) {\n        throw new Error(\n          'Cannot call `render` without having first called `setupRenderingContext`.',\n        );\n      }\n\n      const { owner } = context;\n      const testMetadata = getTestMetadata(context);\n      testMetadata.usedHelpers.push('render');\n\n      // SAFETY: this is all wildly unsafe, because it is all using private API.\n      // At some point we should define a path forward for this kind of internal\n      // API. For now, just flagging it as *NOT* being safe!\n      const toplevelView = owner.lookup('-top-level-view:main') as any;\n      const OutletTemplate = lookupOutletTemplate(owner);\n      const ownerToRenderFrom = options?.owner || owner;\n\n      if (isComponent(templateFactoryOrComponent)) {\n        context = {\n          ProvidedComponent: templateFactoryOrComponent,\n        };\n        templateFactoryOrComponent = INVOKE_PROVIDED_COMPONENT;\n      }\n\n      templateId += 1;\n      const templateFullName = `template:-undertest-${templateId}` as const;\n      ownerToRenderFrom.register(templateFullName, templateFactoryOrComponent);\n      const template = lookupTemplate(ownerToRenderFrom, templateFullName);\n\n      const outletState = {\n        render: {\n          owner, // always use the host app owner for application outlet\n          into: undefined,\n          outlet: 'main',\n          name: 'application',\n          controller: undefined,\n          ViewClass: undefined,\n          template: OutletTemplate,\n        },\n\n        outlets: {\n          main: {\n            render: {\n              owner: ownerToRenderFrom, // the actual owner to be used for any lookups\n              into: undefined,\n              outlet: 'main',\n              name: 'index',\n              controller: context,\n              ViewClass: undefined,\n              template,\n              outlets: {},\n            },\n            outlets: {},\n          },\n        },\n      };\n      toplevelView.setOutletState(outletState);\n\n      // returning settled here because the actual rendering does not happen until\n      // the renderer detects it is dirty (which happens on backburner's end\n      // hook), see the following implementation details:\n      //\n      // * [view:outlet](https://github.com/emberjs/ember.js/blob/f94a4b6aef5b41b96ef2e481f35e07608df01440/packages/ember-glimmer/lib/views/outlet.js#L129-L145) manually dirties its own tag upon `setOutletState`\n      // * [backburner's custom end hook](https://github.com/emberjs/ember.js/blob/f94a4b6aef5b41b96ef2e481f35e07608df01440/packages/ember-glimmer/lib/renderer.js#L145-L159) detects that the current revision of the root is no longer the latest, and triggers a new rendering transaction\n      return settled();\n    })\n    .then(() => runHooks('render', 'end'));\n}\n\n/**\n  Clears any templates previously rendered. This is commonly used for\n  confirming behavior that is triggered by teardown (e.g.\n  `willDestroyElement`).\n\n  @public\n  @returns {Promise<void>} resolves when settled\n*/\nexport function clearRender(): Promise<void> {\n  const context = getContext();\n\n  if (!context || !isRenderingTestContext(context)) {\n    throw new Error(\n      'Cannot call `clearRender` without having first called `setupRenderingContext`.',\n    );\n  }\n\n  return render(EMPTY_TEMPLATE);\n}\n\n/**\n  Used by test framework addons to setup the provided context for rendering.\n\n  `setupContext` must have been ran on the provided context\n  prior to calling `setupRenderingContext`.\n\n  Responsible for:\n\n  - Setup the basic framework used for rendering by the\n    `render` helper.\n  - Ensuring the event dispatcher is properly setup.\n  - Setting `this.element` to the root element of the testing\n    container (things rendered via `render` will go _into_ this\n    element).\n\n  @public\n  @param {TestContext} context the context to setup for rendering\n  @returns {Promise<RenderingTestContext>} resolves with the context that was setup\n\n  @example\n  <caption>\n    Rendering out a paragraph element containing the content 'hello', and then clearing that content via clearRender.\n  </caption>\n\n  await render(hbs`<p>Hello!</p>`);\n  assert.equal(this.element.textContent, 'Hello!', 'has rendered content');\n  await clearRender();\n  assert.equal(this.element.textContent, '', 'has rendered content');\n*/\nexport default function setupRenderingContext(\n  context: TestContext,\n): Promise<RenderingTestContext> {\n  const testMetadata = getTestMetadata(context);\n  testMetadata.setupTypes.push('setupRenderingContext');\n\n  const renderingContext = prepare(context);\n\n  return Promise.resolve()\n    .then(() => {\n      const { owner } = renderingContext;\n\n      // When the host app uses `setApplication` (instead of `setResolver`) the event dispatcher has\n      // already been setup via `applicationInstance.boot()` in `./build-owner`. If using\n      // `setResolver` (instead of `setApplication`) a \"mock owner\" is created by extending\n      // `Ember._ContainerProxyMixin` and `Ember._RegistryProxyMixin` in this scenario we need to\n      // manually start the event dispatcher.\n      if (owner._emberTestHelpersMockOwner) {\n        const dispatcher =\n          owner.lookup('event_dispatcher:main') || EventDispatcher.create();\n        (dispatcher as any).setup({}, '#ember-testing');\n      }\n\n      const OutletView = owner.factoryFor\n        ? owner.factoryFor('view:-outlet')\n        : owner._lookupFactory!('view:-outlet');\n\n      const environment = owner.lookup('-environment:main');\n      const template = owner.lookup('template:-outlet');\n\n      const toplevelView = OutletView.create({\n        template,\n        environment,\n      });\n\n      owner.register('-top-level-view:main', {\n        create() {\n          return toplevelView;\n        },\n      });\n\n      // initially render a simple empty template\n      return render(EMPTY_TEMPLATE).then(() => {\n        run(toplevelView, 'appendTo', getRootElement());\n\n        return settled();\n      });\n    })\n    .then(() => {\n      Object.defineProperty(renderingContext, 'element', {\n        configurable: true,\n        enumerable: true,\n        // In older Ember versions (2.4) the element itself is not stable,\n        // and therefore we cannot update the `this.element` until after the\n        // rendering is completed\n        value: getRootElement(),\n\n        writable: false,\n      });\n\n      return renderingContext;\n    });\n}\n"],"names":["OUTLET_TEMPLATE","precompileTemplate","strictMode","EMPTY_TEMPLATE","INVOKE_PROVIDED_COMPONENT","hasCalledSetupRenderingContext","Symbol","prepare","context","isRenderingTestContext","isTestContext","lookupTemplate","owner","templateFullName","template","lookup","lookupOutletTemplate","OutletTemplate","register","templateId","render","templateFactoryOrComponent","options","getContext","Error","Promise","resolve","then","runHooks","testMetadata","getTestMetadata","usedHelpers","push","toplevelView","ownerToRenderFrom","isComponent","ProvidedComponent","outletState","into","undefined","outlet","name","controller","ViewClass","outlets","main","setOutletState","settled","clearRender","setupRenderingContext","setupTypes","renderingContext","_emberTestHelpersMockOwner","dispatcher","EventDispatcher","create","setup","OutletView","factoryFor","_lookupFactory","environment","run","getRootElement","Object","defineProperty","configurable","enumerable","value","writable"],"mappings":"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"}